var APP3D;!function(){"use strict";function e(e){function t(e){function t(){$(this).remove()}if($(".stars").length>=q)return!1;void 0===e&&(e=U);var a=3.5*Math.random();1===Math.round(1*Math.random())&&(a=-a);var n=e.clientX+$("#fairy").width()/2-7+a,o=e.clientY+$("#fairy").height(),s=$(".stars").clone().removeClass("hide");s.css({top:o+"px",left:n+"px",transform:"rotateY("+(1===Math.round(1*Math.random())?"180":"0")+"deg)"}),$("body").append(s),s.animate({top:"+="+25*Math.random(),opacity:"0"},500*Math.random()+250,t)}function a(){$("#fairy").css({width:E[A][H].width+"px",height:E[A][H].height+"px",backgroundPosition:E[A][H].left+"px "+E[A][H].top+"px"}),H++,t(),H===E[A].length&&(H=0,"move"===A&&(A="idle"))}function n(e){U=e;var t={top:e.clientY+"px",left:e.clientX+"px"};e.clientX-Y<0?t.transform="none":e.clientX-Y>0&&(t.transform="rotateY(180deg)"),e.clientX===Y?A="idle":("idle"===A&&(H=0),A="move"),$("#fairy").css(t),Y=e.clientX}function o(){var e=$(this).find(":selected").val();return $(".sound").removeClass("pause").addClass("play"),M.pause(),""===e?!1:void(M.src=e)}function s(){return""===$(".soundContainer select :selected").val()?!1:void($(this).hasClass("play")?($(this).removeClass("play").addClass("pause"),M.play()):($(this).removeClass("pause").addClass("play"),M.pause()))}function i(){M.volume=$(this).val()}function r(){window.speechSynthesis.resume()}function l(){window.speechSynthesis.pause()}function p(){T.volume=$(this).val()}function d(){$(this).scrollTop()===$("page").get(0).scrollHeight-$("page").height()&&g()}function c(e){function t(){function e(){if(T.onend=t,T.onresume=r,T.onpause=l,0===I.length){a=$(n).filter(":eq("+j+")"),$("page").scrollTop(a.offset().top+$("page").scrollTop()-a.outerHeight()),$("page > *").css("background-color","transparent"),a.css("background-color","gray"),I=a.text().trim().split(".");for(var e=0;e<I.length;e++)I[e]=I[e];j++}var o=I.shift();if(o.length>250){o=o.split(",");for(var e=o.length-1;e>=0;e--)o[e]=o[e]+",",I.unshift(o[e])}else I.unshift(o);T.text=I.shift(),window.speechSynthesis.speak(T)}function t(){function t(){return S?!1:(clearInterval(D),n=$("page > p"),j===n.length?(Number($("#currentPage").val())<Number($("#maxPage").text())&&(g(),D=setInterval(t,250)),!1):void e())}return j===n.length?($("page").scrollTop($("page").get(0).scrollHeight-$("page").height()),D=setInterval(t,250),!1):void e()}var a,n=$("page > p");return 0===n.length?(Number($("#currentPage").val())<Number($("#maxPage").text())&&(g(),D=setInterval(check,250)),!1):void e()}e.preventDefault(),e.stopPropagation(),$(this).hasClass("play")?($(this).hasClass("paused")?(r(),$(this).removeClass("paused")):t(),$(this).removeClass("play").addClass("pause")):($(this).removeClass("pause").addClass("play"),l(),$(this).addClass("paused"))}function h(){var e=Number($(this).val()),t=Number($("#maxPage").text());e>t?(e=t,$(this).val(e)):0>=e&&(e=1,$(this).val(e)),e!==P&&(S=!0,P=e,$("page").empty(),j=0,window.speechSynthesis.cancel(),$(".read").removeClass("paused"),m($(".book :selected").val()))}function u(e){return(e.keyCode<96||e.keyCode>105||S)&&37!==e.keyCode&&39!==e.keyCode&&8!==e.keyCode&&46!==e.keyCode?(e.preventDefault(),e.stopPropagation(),!1):void 0}function g(){return P===Number($("#maxPage").text())||S?!1:(S=!0,P++,void m($(".book :selected").val()))}function f(){return 1===P||S?!1:(S=!0,$("page").empty(),window.speechSynthesis.cancel(),$(".read").removeClass("paused"),j=0,P--,void m($(".book :selected").val()))}function v(){function e(){function e(e){function a(){function e(e){T.lang=e.data.detections[0].language+"-"+e.data.detections[0].language.toUpperCase(),N=window.speechSynthesis.getVoices();for(var t=0;t<N.length;t++)if(N[t].lang===T.lang){T.voice=N[t];break}}$.post("php/getLang.php",{q:$("page").text()},e,"json")}P=e.page,m(t,a)}$.post("php/getCurrentPage.php",{name:t},e,"json")}var t=$(this).find(":selected").val();""!==t?(S=!0,j=0,$("page").empty(),window.speechSynthesis.cancel(),$(".read").removeClass("paused"),e(),$(".bookControl").removeClass("hide"),$(".readContainer").removeClass("hide")):($(".bookControl").addClass("hide"),$(".readContainer").addClass("hide"),$("page").html(""))}function m(e,t){function a(e){$("page").append($("page").html()+((""!==$("page").html()?"<hr>":"")+e.data)),$("#currentPage").val(P),e.nbPage&&$("#maxPage").text(e.nbPage),S=!1,t&&t()}$.post("php/getPage.php",{page:P,name:e},a,"json")}function y(e){return e.preventDefault(),e.stopPropagation(),!1}function C(){$(".background").attr("src","img/"+$(this).val()+".jpg"),$("page").attr("style",$(".theme :selected").attr("pos"))}function w(e){x(e.target.files)}function b(e){e.preventDefault(),e.stopPropagation(),x(e.originalEvent.dataTransfer.files)}function k(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="copy"}function x(e){function t(t){function a(e){if(e.success){var t=$("<option></option>");t.text(e.name),t.val(e.name),$(".book").append(t)}else console.error(e.error)}$.post("php/upload.php",{data:t.target.result,name:e[0].name},a,"json")}var a=new FileReader;a.onload=t,a.readAsDataURL(e[0])}var P=1,S=!1;$("input[type=file]").bind("drop",b),$("input[type=file]").bind("dragover",k),$("input[type=file]").change(w),$(".theme").change(C),$(".book").change(v),$("page").mousedown(y),$(".next").mousedown(g),$(".prev").mousedown(f),$("#currentPage").keydown(u),$("#currentPage").keyup(h),$(".read").mousedown(c),$("page").scroll(d),$("#volumeSpeak").change(p),$(".theme").change(),$(".soundContainer select").change(o),$("#volumeSound").change(i),$(".sound").mousedown(s),$(document).mousemove(n);var D,M=new Audio,N=window.speechSynthesis.getVoices(),T=new SpeechSynthesisUtterance;T.voice="none";var N,X,j=0,I=[],Y=0,A="idle",E={idle:[{height:31,width:22,top:0,left:0},{height:31,width:22,top:0,left:-25},{height:31,width:23,top:0,left:-50}],move:[{height:31,width:22,top:-34,left:0},{height:31,width:22,top:-34,left:-22}]},H=0,U=e,q=100;X=setInterval(a,125)}$(document).ready(e)}();